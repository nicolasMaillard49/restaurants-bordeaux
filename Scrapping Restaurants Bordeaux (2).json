{
  "name": "Scrapping Restaurants Bordeaux",
  "nodes": [
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        80,
        -160
      ],
      "id": "58c310d8-b27b-4e1b-b0e2-bdf554523aa0",
      "name": "Split In Batches"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "30ab23f9-b984-49dc-9b59-436bca3f3eec",
              "name": "name",
              "value": "={{ $('Split In Batches').item.json[\"name\"] }}\n",
              "type": "string"
            },
            {
              "id": "9a451039-8914-47b4-9322-3b0b86ee8b4c",
              "name": "description",
              "value": "={{ $json.body.choices[0].message.content }}",
              "type": "string"
            },
            {
              "id": "02b303cd-1b39-460f-a532-11bd9c0f1d88",
              "name": "rating",
              "value": "={{ $('Split In Batches').item.json[\"rating\"] }}\n",
              "type": "number"
            },
            {
              "id": "66790e87-1197-4740-9539-83e87c086aff",
              "name": "address",
              "value": "={{ $('Split In Batches').item.json.formatted_address }}",
              "type": "string"
            },
            {
              "id": "58bb227f-1ea5-4764-b111-27ba9f062688",
              "name": "city",
              "value": "={{ $('Fotmat Restaurant Data').item.json.city }}",
              "type": "string"
            },
            {
              "id": "5c3970a7-c297-45a3-9c32-94b47732e95f",
              "name": "website",
              "value": "={{ $('Fotmat Restaurant Data').item.json.website }}",
              "type": "string"
            },
            {
              "id": "2f14bcda-3721-47c1-a2d2-8e1d021800d4",
              "name": "phone",
              "value": "={{ $('Fotmat Restaurant Data').item.json.phone }}",
              "type": "string"
            },
            {
              "id": "1006a393-dea8-4e2f-ba14-3b84dddd01aa",
              "name": "opening_hours",
              "value": "={{ $('Fotmat Restaurant Data').item.json.opening_hours }}",
              "type": "array"
            },
            {
              "id": "36f88ecf-dd36-4177-9b0a-dbe26fa645ba",
              "name": "price_level",
              "value": "={{ $('Fotmat Restaurant Data').item.json.price_level }}",
              "type": "number"
            },
            {
              "id": "5645de83-bb86-4dbc-b2d4-9259ccd013fb",
              "name": "google_maps_url",
              "value": "={{ $('Fotmat Restaurant Data').item.json.google_maps_url }}",
              "type": "string"
            },
            {
              "id": "3c3ee427-6a83-4000-8f9c-78a226bbe6de",
              "name": "types",
              "value": "={{ $('Fotmat Restaurant Data').item.json.types }}",
              "type": "array"
            },
            {
              "id": "638a30b4-03ba-44f8-b565-fbeb7883fa53",
              "name": "reviews",
              "value": "={{ $('Fotmat Restaurant Data').item.json.reviews }}",
              "type": "array"
            },
            {
              "id": "db76f89b-e78f-474e-ad3f-62c47fb0f8d1",
              "name": "images",
              "value": "={{ $('Fotmat Restaurant Data').item.json.photos }}",
              "type": "array"
            },
            {
              "id": "e04e7cd8-9137-4413-b699-2cd4a73c82fb",
              "name": "source",
              "value": "google_maps",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        752,
        -144
      ],
      "id": "de3ffc03-acd6-4b56-a335-253ce8004915",
      "name": "Prepare JSON"
    },
    {
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconsole.log('Restaurant imported:', response);\nreturn [{ json: response }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        -176
      ],
      "id": "8dd89878-b32c-40d3-b7aa-394f490db72a",
      "name": "Log Success"
    },
    {
      "parameters": {
        "jsCode": "// RÃ©cupÃ©rer la rÃ©ponse de Google Places\nconst response = $input.all()[0].json;\n\n// VÃ©rifier s'il y a des rÃ©sultats\nif (!response.results || response.results.length === 0) {\n  console.log('âŒ Aucun restaurant trouvÃ©');\n  return [];\n}\n\nconsole.log(`âœ… ${response.results.length} restaurants trouvÃ©s`);\n\n// Retourner chaque restaurant comme un item sÃ©parÃ©\nreturn response.results.map(restaurant => ({\n  json: restaurant\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -320,
        -160
      ],
      "id": "418c3e35-7224-4dd7-8357-46026d64e942",
      "name": "Extract result"
    },
    {
      "parameters": {
        "jsCode": "// âš ï¸ Place Details renvoie les donnÃ©es dans result, pas directement dans json\nconst restaurant = $input.item.json.result;\n\n// Fonction pour extraire la ville de l'adresse\n// Exemple : \"46 Rue des Trois-Conils, 33000 Bordeaux, France\" â†’ \"Bordeaux\"\nconst extractCity = (address) => {\n  if (!address) return 'Bordeaux';\n\n  // Chercher le pattern : code postal (5 chiffres) + ville\n  const match = address.match(/\\d{5}\\s+([^,]+)/);\n  return match ? match[1].trim() : 'Bordeaux';\n};\n\n// Convertir les photos en URLs utilisables\nconst getPhotoUrls = (photos) => {\n  if (!photos || photos.length === 0) return [];\n\n  // Prendre les 5 premiÃ¨res photos\n  return photos.slice(0, 5).map(photo => {\n    return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photo_reference=${photo.photo_reference}&key=AIzaSyBoOcs0Ob0MBKRDVZ37wVeIECTIsqsEBQ8`;\n  });\n};\n\n// Extraire les types/catÃ©gories lisibles\nconst getCategories = (types) => {\n  if (!types) return [];\n\n  // Filtrer les types gÃ©nÃ©riques\n  const excluded = ['establishment', 'point_of_interest', 'food'];\n  return types.filter(t => !excluded.includes(t));\n};\n\n// Formater les donnÃ©es complÃ¨tes\nconst formattedData = {\n  name: restaurant.name || 'Restaurant sans nom',\n  rating: restaurant.rating || 0,\n  address: restaurant.formatted_address || '',\n  city: extractCity(restaurant.formatted_address),\n  business_status: restaurant.business_status || 'UNKNOWN',\n  place_id: restaurant.place_id || '',\n  user_ratings_total: restaurant.user_ratings_total || 0,\n\n  // ðŸ†• Nouvelles donnÃ©es de Place Details\n  website: restaurant.website || null,\n  phone: restaurant.formatted_phone_number || null,\n  opening_hours: restaurant.opening_hours?.weekday_text || [],\n  price_level: restaurant.price_level || null,\n  google_maps_url: restaurant.url || null,\n  types: getCategories(restaurant.types),\n  photos: getPhotoUrls(restaurant.photos),\n\n  // Les 5 premiers avis (pour afficher sur le frontend)\n  reviews: (restaurant.reviews || []).slice(0, 5).map(review => ({\n    author: review.author_name,\n    rating: review.rating,\n    text: review.text,\n    date: review.relative_time_description\n  }))\n};\n\nconsole.log('ðŸ“ Restaurant formatÃ©:', formattedData.name, '- Website:', formattedData.website);\n\nreturn { json: formattedData };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        -144
      ],
      "id": "e40fc30e-c7b1-4bcb-bf9c-3a203985c75e",
      "name": "Fotmat Restaurant Data"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.groq.com/openai/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer YOUR_GROQ_API_KEY"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"llama-3.3-70b-versatile\",\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": \"Tu es un rÃ©dacteur web spÃ©cialisÃ© en gastronomie. CrÃ©e une description professionnelle et engageante pour ce restaurant de Bordeaux (2-3 phrases maximum). Nom : {{ $json.name }}, Note : {{ $json.rating }}/5, Adresse : {{ $json.address }}. Retourne UNIQUEMENT la description, sans titre ni formatage.\"\n    }\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 200\n}\n",
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        608,
        -464
      ],
      "id": "fedaa074-10ee-4b4a-bec2-f0eda648ac7e",
      "name": "Groq - Generate Description",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "url": "https://maps.googleapis.com/maps/api/place/details/json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "place_id",
              "value": "={{ $json.place_id }}"
            },
            {
              "name": "fields",
              "value": "name,formatted_address,rating,website,formatted_phone_number,opening_hours,price_level,reviews,url,types,user_ratings_total,business_status,photos"
            },
            {
              "name": "key",
              "value": "AIzaSyBoOcs0Ob0MBKRDVZ37wVeIECTIsqsEBQ8"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        256,
        -16
      ],
      "id": "389baedc-ecbc-4959-8469-1076278eb6cd",
      "name": "Place Details"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://backend:3000/scraper/import",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "nicolas123"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "name",
              "value": "={{ $json.name }}"
            },
            {
              "name": "description",
              "value": "={{ $json.description }}"
            },
            {
              "name": "rating",
              "value": "={{ $json.rating }}"
            },
            {
              "name": "address",
              "value": "={{ $json.address }}"
            },
            {
              "name": "city",
              "value": "={{ $json.city }}"
            },
            {
              "name": "website",
              "value": "={{ $json.website }}"
            },
            {
              "name": "phone",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "opening_hours",
              "value": "={{ $json.opening_hours }}"
            },
            {
              "name": "price_level",
              "value": "={{ $json.price_level }}"
            },
            {
              "name": "google_maps_url",
              "value": "={{ $json.google_maps_url }}"
            },
            {
              "name": "types",
              "value": "={{ $json.types }}"
            },
            {
              "name": "reviews",
              "value": "={{ $json.reviews }}"
            },
            {
              "name": "images",
              "value": "={{ $json.images }}"
            },
            {
              "name": "source",
              "value": "={{ $json.source }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        960,
        -144
      ],
      "id": "2ff64612-f19c-4106-8f28-abd97dd12a86",
      "name": "Import to Backend"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -992,
        -160
      ],
      "id": "d0115884-8441-4080-bc7c-ca41a0931e0e",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "url": "https://maps.googleapis.com/maps/api/place/textsearch/json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ $json.query }}"
            },
            {
              "name": "key",
              "value": "AIzaSyBoOcs0Ob0MBKRDVZ37wVeIECTIsqsEBQ8"
            },
            {
              "name": "language",
              "value": "fr"
            },
            {
              "name": "type",
              "value": "restaurant"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -464,
        -368
      ],
      "id": "b74f5143-4096-46d7-95a5-626782d22db7",
      "name": "google maps search"
    },
    {
      "parameters": {
        "jsCode": "const searches = [\n  // Types de cuisine\n  \"restaurant franÃ§ais bordeaux\",\n  \"restaurant italien bordeaux\",\n  \"restaurant japonais bordeaux\",\n  \"restaurant chinois bordeaux\",\n  \"restaurant indien bordeaux\",\n  \"restaurant mexicain bordeaux\",\n  \"restaurant libanais bordeaux\",\n  \"restaurant thaÃ¯ bordeaux\",\n  \"restaurant espagnol bordeaux\",\n  \"restaurant amÃ©ricain bordeaux\",\n  \"bistrot bordeaux\",\n  \"brasserie bordeaux\",\n  \"restaurant gastronomique bordeaux\",\n  \"restaurant tapas bordeaux\",\n  \"pizzeria bordeaux\",\n  \n  // Quartiers\n  \"restaurant Saint-Pierre Bordeaux\",\n  \"restaurant Chartrons Bordeaux\",\n  \"restaurant Bastide Bordeaux\",\n  \"restaurant Victoire Bordeaux\",\n  \"restaurant Capucins Bordeaux\",\n  \"restaurant Saint-Michel Bordeaux\",\n  \"restaurant MÃ©riadeck Bordeaux\",\n  \"restaurant Bacalan Bordeaux\",\n  \"restaurant Grand Parc Bordeaux\",\n  \"restaurant CaudÃ©ran Bordeaux\"\n];\n\nreturn searches.map(query => ({ json: { query } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -784,
        -160
      ],
      "id": "1d41df88-1d47-45f1-8150-b1b24fe45ee6",
      "name": "Liste des recherches"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -592,
        -160
      ],
      "id": "79a54ef6-57b4-4e93-a2f5-eea95b77225a",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "jsCode": "// Garde seulement 1 ou 2 rÃ©sultats\nconst limit = 10; // mets 1 ou 2\nreturn $input.all().slice(0, limit);\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -112,
        -160
      ],
      "id": "e102a171-d53b-4aad-a9c8-dc5c3f60594e",
      "name": "limit"
    }
  ],
  "pinData": {},
  "connections": {
    "Split In Batches": {
      "main": [
        [],
        [
          {
            "node": "Place Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare JSON": {
      "main": [
        [
          {
            "node": "Import to Backend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract result": {
      "main": [
        [
          {
            "node": "limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fotmat Restaurant Data": {
      "main": [
        [
          {
            "node": "Groq - Generate Description",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Groq - Generate Description": {
      "main": [
        [
          {
            "node": "Prepare JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Place Details": {
      "main": [
        [
          {
            "node": "Fotmat Restaurant Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Import to Backend": {
      "main": [
        [
          {
            "node": "Log Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Success": {
      "main": [
        []
      ]
    },
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Liste des recherches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "google maps search": {
      "main": [
        [
          {
            "node": "Extract result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Liste des recherches": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "google maps search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "limit": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "cb5222c7-8164-4c19-8a77-0a8bcad7a058",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2a1cec70b32c558ac32f0e6d4c07d654484bd16978732619dc99d3cd7b3ff86f"
  },
  "id": "ycUf2PkzKO7fBAbosychy",
  "tags": []
}